# 最终实施方案确认

## 📋 问题与答案对比确认

### ✅ 问题1: 视频处理的后端实现

**您的回答**: YouTube/TikTok视频处理通过 **rapidapi.com** 提供的API能下载文案和视频

**最终方案**:
- ✅ 使用 **RapidAPI** 作为视频处理服务
- ✅ `/api/media/submit/route.ts` 作为任务分发器，创建 `pending` 状态的任务
- ✅ 调用 RapidAPI 进行异步处理
- ✅ 通过 Webhook 或轮询接收处理结果

**需要确认**:
- RapidAPI 的具体端点是什么？
- 是否需要 RapidAPI 的 API Key？
- RapidAPI 返回的数据格式是什么？

---

### ✅ 问题2: 视频处理技术栈

**您的回答**: 通过 **rapidapi.com** 提供的API能下载文案和视频

**最终方案**:
- ✅ **视频下载**: 使用 RapidAPI
- ✅ **字幕提取**: 使用 RapidAPI（可能返回原生字幕或通过ASR生成）
- ✅ **元数据提取**: 通过 RapidAPI 获取（标题、点赞、播放量、转发等）

**需要确认**:
- RapidAPI 是否同时返回视频元数据（标题、点赞、播放量、转发）？
- 如果 RapidAPI 不返回某些元数据，是否需要额外调用其他API？

---

### ✅ 问题3: Gemini API集成

**您的回答**: Gemini API已经申请好了

**最终方案**:
- ✅ 使用 Gemini API 进行字幕翻译
- ✅ 模型: `gemini-1.5-flash`
- ✅ 环境变量: `GEMINI_API_KEY`（已配置）

**需要确认**:
- Gemini API Key 是否已经添加到环境变量中？
- 是否需要测试 Gemini API 的可用性？

---

### ⚠️ 问题4: UI布局的具体要求

**您的回答**: UI的布局你可以看程序，现在不需要改变

**我的理解**:
- 查看现有 `src/shared/blocks/generator/media.tsx` 的UI布局
- **不改变现有UI结构**
- 但需要确保：**客户选择翻译语言，然后点击开始翻译才能进行**

**当前UI分析**（基于代码）:
```tsx
// 当前布局：
1. URL输入框
2. 源语言显示（只读，当检测到后显示）
3. 目标语言下拉菜单（12种语言）
4. 输出类型下拉菜单（subtitle/video）
5. 提取按钮
```

**需要确认**:
- ✅ 保持现有UI布局不变
- ✅ 但需要确保翻译流程：用户必须先选择目标语言，然后点击"开始翻译"按钮
- ❓ 是否需要在第一阶段（提取原生字幕）完成后，**禁用**提取按钮，**启用**翻译按钮？
- ❓ 还是保持一个按钮，但根据任务状态改变按钮文本和功能？

**建议的交互流程**:
1. 用户输入URL，选择目标语言，选择输出类型（subtitle）
2. 点击"提取字幕"按钮 → 第一阶段开始（3分钟）
3. 第一阶段完成后：
   - 显示原生SRT下载按钮
   - **如果用户选择了目标语言**，显示"开始翻译"按钮
   - 用户点击"开始翻译" → 第二阶段开始（1分钟）
4. 第二阶段完成后：
   - 显示翻译后的SRT下载按钮

**请确认**: 这个交互流程是否符合您的要求？

---

### ✅ 问题5: 两阶段处理流程

**您的回答**: 需要客户选择翻译语言，然后点击开始翻译才能进行

**最终方案**:
- ✅ **第一阶段**: 提取原生字幕（约3分钟）
- ✅ **第二阶段**: 用户选择翻译语言 → 点击"开始翻译" → 使用Gemini翻译（约1分钟）
- ✅ **任务状态管理**: 更新现有任务记录
  - `pending` → `extracting` → `extracted` → `translating` → `completed`
- ✅ **数据库字段**: 使用 `status` 字段追踪状态

**需要确认**:
- 用户是否可以在第一阶段进行时就选择目标语言？
- 还是必须等第一阶段完成后才能选择翻译语言？

---

### ✅ 问题6: ShipAny框架扩展规范

**您的回答**: 其它的答复看上面（指您之前的详细回答）

**最终方案**（基于您之前的回答）:
- ✅ **业务逻辑**: `src/services/videoService.ts`（或 `src/shared/services/media.ts`）
- ✅ **API层**: `src/app/api/media/...`
- ✅ **组件层**: `src/shared/blocks/generator/media.tsx`（现有文件）
- ✅ **配置管理**:
  - API Keys: 环境变量（`.env.local`）
  - 用户偏好/任务历史: Neon数据库

**需要确认**:
- ShipAny是否已有 `src/services` 目录，还是应该放在 `src/shared/services`？

---

## 📝 补充方案确认

### 视频暂存24小时

**您的回答**: 看上面的详细回答（使用Cloudflare R2 + Lifecycle Rule）

**最终方案**:
- ✅ 使用 **Cloudflare R2** 存储视频
- ✅ 设置 Lifecycle Rule: 1天后自动删除
- ✅ 生成预签名URL（24小时有效）

**需要确认**:
- R2是否已经配置？
- Bucket名称是什么？

---

## 🎯 最终技术栈总结

### 核心服务
1. **视频处理**: RapidAPI
2. **字幕翻译**: Gemini 1.5 Flash
3. **视频存储**: Cloudflare R2
4. **数据库**: Neon PostgreSQL

### 数据流程
```
用户输入URL
  ↓
创建mediaTasks记录（status: pending）
  ↓
调用RapidAPI提取视频/字幕
  ↓
更新mediaTasks记录（status: extracting → extracted）
  ↓
保存元数据（title, likes, views, shares等）
  ↓
生成原生SRT文件
  ↓
[用户选择翻译语言，点击"开始翻译"]
  ↓
调用Gemini API翻译
  ↓
更新mediaTasks记录（status: translating → completed）
  ↓
生成翻译后SRT文件
```

---

## ❓ 仍需确认的问题

### 1. RapidAPI配置
- [ ] RapidAPI的具体端点URL是什么？
- [ ] 需要哪个RapidAPI服务（YouTube Downloader、TikTok Downloader等）？
- [ ] RapidAPI的API Key环境变量名称是什么？
- [ ] RapidAPI返回的数据格式是什么（JSON结构）？

### 2. UI交互细节
- [ ] 翻译按钮是在第一阶段完成后自动出现，还是始终显示但禁用？
- [ ] 用户是否可以在第一阶段进行时就选择目标语言？
- [ ] 如果用户没有选择目标语言，是否只提供原生SRT下载？

### 3. 元数据提取
- [ ] RapidAPI是否返回完整的元数据（标题、点赞、播放量、转发、作者、发布时间等）？
- [ ] 如果RapidAPI不返回某些字段，是否需要额外处理？

### 4. 错误处理
- [ ] RapidAPI调用失败时的降级方案是什么？
- [ ] Gemini翻译失败时的降级方案是什么（使用DeepL或其他）？

### 5. 数据库字段
- [ ] 是否需要添加 `subtitle_text` 和 `translated_text` 字段存储字幕文本？
- [ ] 是否需要添加 `video_expires_at` 字段记录视频过期时间？

---

## 📋 实施检查清单

### Phase 1: 基础功能
- [ ] 配置RapidAPI集成
- [ ] 实现视频/字幕提取逻辑
- [ ] 实现元数据提取和保存
- [ ] 实现原生SRT生成和下载

### Phase 2: 翻译功能
- [ ] 集成Gemini API
- [ ] 实现两阶段翻译流程
- [ ] 实现翻译后SRT生成和下载

### Phase 3: 存储和优化
- [ ] 配置R2存储和Lifecycle Rule
- [ ] 实现视频暂存和预签名URL
- [ ] 优化进度条和Loading动效

### Phase 4: 数据导出
- [ ] 实现CSV导出功能
- [ ] 添加导出按钮到相应页面

---

## 🔄 重复确认（请核对）

### 问题1: 视频处理后端
**问题**: 视频处理的后端实现方式是什么？
**您的答案**: 使用 **RapidAPI** 提供的API下载文案和视频
**最终确认**: ✅ 使用RapidAPI

### 问题2: 视频处理技术栈
**问题**: YouTube/TikTok视频下载和字幕提取使用什么技术？
**您的答案**: 通过 **RapidAPI** 提供的API
**最终确认**: ✅ 使用RapidAPI

### 问题3: Gemini API集成
**问题**: Gemini API是否已配置？
**您的答案**: Gemini API已经申请好了
**最终确认**: ✅ 已准备好，需要添加到环境变量

### 问题4: UI布局
**问题**: UI布局是否需要改变？
**您的答案**: UI的布局你可以看程序，现在不需要改变
**最终确认**: ✅ 保持现有UI，但需确保翻译流程正确

### 问题5: 两阶段翻译
**问题**: 两阶段翻译流程如何实现？
**您的答案**: 需要客户选择翻译语言，然后点击开始翻译才能进行
**最终确认**: ✅ 用户选择语言 → 点击翻译 → 执行翻译

### 问题6: ShipAny框架规范
**问题**: 如何遵循ShipAny框架扩展规范？
**您的答案**: 看上面的详细回答（业务逻辑、API层、组件层、配置管理）
**最终确认**: ✅ 遵循ShipAny目录结构

---

## 🚀 下一步行动

1. **等待您的最终确认**:
   - 确认上述理解是否正确
   - 回答"仍需确认的问题"部分

2. **准备开始编码**:
   - 一旦确认，我将开始实施
   - 优先实现核心功能（RapidAPI集成、Gemini翻译）

3. **分阶段实施**:
   - Phase 1: 基础功能（视频提取、元数据保存）
   - Phase 2: 翻译功能（Gemini集成、两阶段流程）
   - Phase 3: 存储优化（R2配置、视频暂存）
   - Phase 4: 数据导出（CSV功能）

---

**请确认以上理解是否正确，特别是UI交互流程部分！**


