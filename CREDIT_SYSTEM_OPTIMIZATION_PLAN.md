# ç§¯åˆ†ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆä¸é£é™©åˆ†æ

## ğŸ“Š å½“å‰å®ç°åˆ†æ

### âœ… ShipAnyå·²æœ‰å®Œæ•´çš„ç§¯åˆ†ç³»ç»Ÿ

1. **ç§¯åˆ†è¡¨ç»“æ„** (`credit` è¡¨)
   - âœ… æ”¯æŒFIFOé˜Ÿåˆ—æ¶ˆè´¹
   - âœ… æ”¯æŒè¿‡æœŸå¤„ç†
   - âœ… æ”¯æŒå¤±è´¥è¿”è¿˜ï¼ˆé€šè¿‡ `consumedDetail` è®°å½•ï¼‰

2. **ç°æœ‰å‡½æ•°**
   - âœ… `consumeCredits()` - æ‰£é™¤ç§¯åˆ†ï¼ˆäº‹åŠ¡ä¿æŠ¤ï¼Œè‡ªåŠ¨æ£€æŸ¥ä½™é¢ï¼‰
   - âœ… `getRemainingCredits()` - è·å–å‰©ä½™ç§¯åˆ†
   - âœ… `updateAITaskById()` - ä»»åŠ¡å¤±è´¥æ—¶è¿”è¿˜ç§¯åˆ†

### âš ï¸ Mediaä»»åŠ¡å½“å‰å®ç°çš„é—®é¢˜

#### é—®é¢˜1: ç§¯åˆ†æ‰£é™¤æ—¶æœºä¸å½“
**å½“å‰å®ç°**:
```typescript
// åœ¨åå°å¼‚æ­¥å‡½æ•° processMediaTask ä¸­æ‰£é™¤
async function processMediaTask(...) {
  await consumeCredits({ ... }); // æ‰£é™¤ç§¯åˆ†
  // ç„¶åæ‰å¼€å§‹å¤„ç†
}
```

**é£é™©**:
- âŒ ç”¨æˆ·æäº¤ä»»åŠ¡åï¼Œå¦‚æœåå°å¤„ç†å¤±è´¥ï¼Œç§¯åˆ†å·²æ‰£é™¤ä½†æ— æ³•è¿”è¿˜
- âŒ æ²¡æœ‰ä¿å­˜ `creditId`ï¼Œæ— æ³•è¿½è¸ªå’Œè¿”è¿˜
- âŒ ç”¨æˆ·éœ€è¦ç­‰å¾…æ‰çŸ¥é“ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ

#### é—®é¢˜2: ç¼ºå°‘å¤±è´¥è¿”è¿˜æœºåˆ¶
**å½“å‰å®ç°**:
```typescript
catch (error) {
  await updateMediaTaskById(taskId, {
    status: 'failed',
    errorMessage: error.message,
  });
  // âŒ æ²¡æœ‰è¿”è¿˜ç§¯åˆ†
}
```

**é£é™©**:
- âŒ ä»»åŠ¡å¤±è´¥æ—¶ç§¯åˆ†æŸå¤±
- âŒ ç”¨æˆ·ä½“éªŒå·®

#### é—®é¢˜3: ç¼ºå°‘ `creditId` å­—æ®µ
**å½“å‰çŠ¶æ€**:
- `aiTask` è¡¨æœ‰ `creditId` å­—æ®µ âœ…
- `mediaTasks` è¡¨æ²¡æœ‰ `creditId` å­—æ®µ âŒ

---

## ğŸ” é£é™©è¯„ä¼°

### é£é™©1: å¹¶å‘é—®é¢˜ âš ï¸ ä¸­ç­‰é£é™©
**åœºæ™¯**: ä¸¤ä¸ªè¯·æ±‚åŒæ—¶æäº¤ï¼Œéƒ½é€šè¿‡å‰ç«¯æ£€æŸ¥
**å½“å‰ç¼“è§£**: `consumeCredits()` ä½¿ç”¨äº‹åŠ¡ï¼Œä½†æ£€æŸ¥æ—¶æœºåœ¨åå°
**å½±å“**: å¯èƒ½åˆ›å»ºæ— æ•ˆä»»åŠ¡ï¼Œæµªè´¹èµ„æº

### é£é™©2: ç§¯åˆ†æŸå¤± âš ï¸ é«˜é£é™©
**åœºæ™¯**: ä»»åŠ¡å¤±è´¥ä½†ç§¯åˆ†å·²æ‰£é™¤
**å½“å‰çŠ¶æ€**: âŒ æœªå®ç°è¿”è¿˜
**å½±å“**: ç”¨æˆ·ç§¯åˆ†æŸå¤±ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

### é£é™©3: æ£€æŸ¥å»¶è¿Ÿ âš ï¸ ä½é£é™©
**åœºæ™¯**: ç”¨æˆ·æäº¤åæ‰çŸ¥é“ç§¯åˆ†ä¸è¶³
**å½“å‰çŠ¶æ€**: å‰ç«¯æœ‰æ£€æŸ¥ï¼Œä½†åç«¯æ£€æŸ¥åœ¨åå°
**å½±å“**: ç”¨æˆ·ä½“éªŒç¨å·®

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆA: åœ¨APIè·¯ç”±ä¸­æå‰æ£€æŸ¥ï¼ˆæ¨èï¼‰â­

**ä¼˜ç‚¹**:
- âœ… ç«‹å³åé¦ˆç§¯åˆ†ä¸è¶³
- âœ… é¿å…æ— æ•ˆä»»åŠ¡åˆ›å»º
- âœ… ç¬¦åˆShipAnyç°æœ‰æ¨¡å¼ï¼ˆå‚è€ƒAIä»»åŠ¡ï¼‰
- âœ… å¯ä»¥ä¿å­˜ `creditId` ç”¨äºè¿”è¿˜

**å®æ–½æ­¥éª¤**:
1. æ·»åŠ  `creditId` å­—æ®µåˆ° `mediaTasks` è¡¨
2. ä¿®æ”¹ `createMediaTask` æ”¯æŒç§¯åˆ†æ‰£é™¤ï¼ˆå‚è€ƒ `createAITask`ï¼‰
3. ä¿®æ”¹ `updateMediaTaskById` æ”¯æŒç§¯åˆ†è¿”è¿˜ï¼ˆå‚è€ƒ `updateAITaskById`ï¼‰
4. è°ƒæ•´ `/api/media/submit` è·¯ç”±ï¼šåœ¨åˆ›å»ºä»»åŠ¡å‰æ£€æŸ¥å¹¶æ‰£é™¤ç§¯åˆ†
5. è°ƒæ•´ `/api/media/translate` è·¯ç”±ï¼šåŒæ ·å¤„ç†

**ä»£ç æ”¹åŠ¨**:
- Schema: æ·»åŠ  `creditId` å­—æ®µ
- `createMediaTask`: æ·»åŠ ç§¯åˆ†æ‰£é™¤é€»è¾‘
- `updateMediaTaskById`: æ·»åŠ å¤±è´¥è¿”è¿˜é€»è¾‘
- APIè·¯ç”±: è°ƒæ•´ç§¯åˆ†æ£€æŸ¥æ—¶æœº

### æ–¹æ¡ˆB: åˆ›å»ºç§¯åˆ†æ£€æŸ¥è¾…åŠ©å‡½æ•°ï¼ˆå¯é€‰ï¼‰

**ç›®çš„**: ç»Ÿä¸€ç§¯åˆ†æ£€æŸ¥é€»è¾‘

**å®ç°**: 
```typescript
// src/shared/services/media/credit-guard.ts
export async function checkCreditsBeforeTask(
  userId: string,
  cost: number
): Promise<void> {
  const remaining = await getRemainingCredits(userId);
  if (remaining < cost) {
    throw new Error(`Insufficient credits. Required: ${cost}, Available: ${remaining}`);
  }
}
```

**ä¼˜ç‚¹**: 
- âœ… ä»£ç å¤ç”¨
- âœ… ç»Ÿä¸€é”™è¯¯ä¿¡æ¯

**ç¼ºç‚¹**: 
- âš ï¸ åªæ˜¯æ£€æŸ¥ï¼Œä¸æ‰£é™¤ï¼ˆæ‰£é™¤ä»éœ€åœ¨äº‹åŠ¡ä¸­ï¼‰

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### é‡‡ç”¨æ–¹æ¡ˆAï¼ˆåœ¨APIè·¯ç”±ä¸­æå‰æ£€æŸ¥ï¼‰

**ç†ç”±**:
1. âœ… ç¬¦åˆShipAnyç°æœ‰æ¨¡å¼ï¼ˆAIä»»åŠ¡å°±æ˜¯è¿™æ ·åšçš„ï¼‰
2. âœ… å¯ä»¥ä¿å­˜ `creditId` ç”¨äºå¤±è´¥è¿”è¿˜
3. âœ… ç«‹å³åé¦ˆï¼Œç”¨æˆ·ä½“éªŒå¥½
4. âœ… äº‹åŠ¡ä¿æŠ¤ï¼Œé¿å…å¹¶å‘é—®é¢˜

### å®æ–½ç»†èŠ‚

#### 1. Schemaä¿®æ”¹
```typescript
// src/config/db/schema.ts - mediaTasksè¡¨
creditId: text('credit_id'), // credit consumption record id
```

#### 2. ä¿®æ”¹ createMediaTask
```typescript
// å‚è€ƒ createAITask çš„å®ç°
// åœ¨äº‹åŠ¡ä¸­ï¼šåˆ›å»ºä»»åŠ¡ + æ‰£é™¤ç§¯åˆ† + ä¿å­˜creditId
```

#### 3. ä¿®æ”¹ updateMediaTaskById
```typescript
// å‚è€ƒ updateAITaskById çš„å®ç°
// å¦‚æœçŠ¶æ€å˜ä¸º failed ä¸”æœ‰ creditIdï¼Œè¿”è¿˜ç§¯åˆ†
```

#### 4. è°ƒæ•´ APIè·¯ç”±
```typescript
// /api/media/submit
// 1. æ£€æŸ¥ç§¯åˆ†ï¼ˆæå‰ï¼‰
// 2. åˆ›å»ºä»»åŠ¡ï¼ˆæ‰£é™¤ç§¯åˆ†ï¼Œä¿å­˜creditIdï¼‰
// 3. å¯åŠ¨åå°å¤„ç†
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸éœ€è¦å…¨å±€Middleware
**åŸå› **:
- âœ… ShipAnyå·²æœ‰å®Œæ•´çš„ç§¯åˆ†ç³»ç»Ÿ
- âœ… `consumeCredits()` å·²å®ç°äº‹åŠ¡ä¿æŠ¤
- âœ… åœ¨APIè·¯ç”±ä¸­å¤„ç†å³å¯

### 2. ä¸éœ€è¦é¢å¤–çš„credit-guard.ts
**åŸå› **:
- âœ… `consumeCredits()` å·²å®ç°ä½™é¢æ£€æŸ¥
- âœ… åœ¨åˆ›å»ºä»»åŠ¡æ—¶æ‰£é™¤å³å¯ï¼ˆå‚è€ƒAIä»»åŠ¡ï¼‰

### 3. å¤±è´¥è¿”è¿˜æœºåˆ¶
**é‡è¦**: å¿…é¡»å®ç°å¤±è´¥è¿”è¿˜ï¼Œå¦åˆ™ç”¨æˆ·ç§¯åˆ†ä¼šæŸå¤±

---

## ğŸ“‹ å®æ–½æ£€æŸ¥æ¸…å•

- [ ] æ·»åŠ  `creditId` å­—æ®µåˆ° `mediaTasks` è¡¨
- [ ] ä¿®æ”¹ `createMediaTask` æ”¯æŒç§¯åˆ†æ‰£é™¤
- [ ] ä¿®æ”¹ `updateMediaTaskById` æ”¯æŒç§¯åˆ†è¿”è¿˜
- [ ] è°ƒæ•´ `/api/media/submit` è·¯ç”±é€»è¾‘
- [ ] è°ƒæ•´ `/api/media/translate` è·¯ç”±é€»è¾‘
- [ ] æµ‹è¯•ç§¯åˆ†æ‰£é™¤å’Œè¿”è¿˜æµç¨‹

---

**å‡†å¤‡å¼€å§‹å®æ–½...**


